# Tab Position Options - オリジナル拡張機能仕様書

## 概要

Tab Position Optionsは、タブの動作と配置を包括的に制御できるChrome拡張機能です。このドキュメントは、実装に基づいたオリジナル拡張機能の完全な動作仕様、アーキテクチャ設計、および実装時の考慮事項を記述しています。

## アーキテクチャ概要

### コンポーネント構造

拡張機能は協調して動作する3つの主要コンポーネントで構成されています：

1. **バックグラウンドスクリプト（永続的バックグラウンドページ）**
   - すべてのタブ管理ロジックの中央ハブ
   - ブラウザセッション間で永続的な状態を維持
   - すべてのChrome APIイベントを処理し、応答を調整
   - タブアクティベーション履歴や親子関係を含む複雑な状態を管理

2. **コンテンツスクリプト**
   - リンク動作の変更を処理するためにWebページに注入
   - DOM変更を監視して動的にリンク動作を更新
   - URLパターンマッチングのためバックグラウンドスクリプトと通信
   - 強制的なタブ開き動作のためのクリックイベントを処理

3. **オプションページ**
   - 設定管理のためのユーザーインターフェース
   - Chrome Storage APIに直接書き込み
   - 設定の可搬性のためのインポート/エクスポート機能を提供

### データフローと通信

拡張機能はメッセージパッシングアーキテクチャを使用：
- コンテンツスクリプトはページロード時にバックグラウンドスクリプトから設定を要求
- バックグラウンドスクリプトはすべてのタブ操作の権威ある状態を維持
- オプションページの変更はストレージリスナーを通じて即座に反映
- すべてのコンポーネントはChrome Storageの変更に反応してリアルタイム更新を実現

## 中核概念と設計思想

### タブアクティベーション履歴管理

拡張機能は洗練されたアクティベーション履歴システムを維持：

**目的**: タブを閉じる際のインテリジェントなタブ切り替えを実現、特に「アクティブ化順」と「元タブ」オプション用。

**主要概念**：
- 各ウィンドウは独立したアクティベーション順序リストを維持
- リストはタブがアクティベート（フォーカス）された順序を追跡
- 最近アクティベートされたタブはリストの末尾に表示
- 現在アクティブなタブは常に最後のエントリ

**実装時の考慮事項**：
- ウィンドウ間のタブ移動を処理する必要がある
- タブが閉じられたり切り離されたりしたときのクリーンアップが必要
- 多数のタブでのパフォーマンス影響を考慮
- 高速なタブ切り替え時のレースコンディションには特別な処理が必要

### 親子タブ関係

拡張機能はどのタブがどのタブを開いたか（opener関係）を追跡：

**目的**: 子タブが閉じられたときに元のタブに戻るための「元タブ（リンクを開く）」機能をサポート。

**追跡メカニズム**：
- `chrome.webNavigation.onCreatedNavigationTarget`イベントを監視
- 子タブIDから親タブID（sourceTabId）へのマッピングを維持
- 関係はメモリ内でのみ保存され、永続化されない
- タブが閉じられたときに関係をクリーンアップ

**動作**：
- tabfocus=7（元タブのみ）でタブを閉じた場合、親タブが存在すれば親タブに切り替える
- tabfocus=8（元タブとアクティブ化順）でタブを閉じた場合、まず親タブを試み、次にアクティベーション順序にフォールバック
- 親タブがもう存在しない場合、デフォルト動作またはアクティベーション順序にフォールバック

### ウィンドウ固有の状態管理

各ブラウザウィンドウは独立した状態を維持：

**理論的根拠**: ユーザーは異なるタスクのために複数のウィンドウを使用することが多く、個別のタブ管理コンテキストが必要。

**ウィンドウごとの管理状態**：
- タブアクティベーション順序
- 現在アクティブなタブ
- 次のアクティブタブを決定するための最近のタブ削除フラグ

**同期の課題**：
- 新しいウィンドウが作成されたときに状態を初期化する必要がある
- ウィンドウフォーカスの変更は内部ウィンドウ状態に影響しない
- ポップアップウィンドウはタブへの変換のために特別な処理が必要

## 設定カテゴリ

### 1. New Tab（新規タブ）

ブラウザの新規タブボタン（Ctrl+T、プラスボタンなど）を使用した際のタブ開き位置を制御します。

#### オプション：
- **Always first（常に最初）**: 新規タブは常にタブバーの先頭に開きます
- **Always last（常に最後）**: 新規タブは常にタブバーの末尾に開きます
- **Right of current tab（現在のタブの右）**: 新規タブは現在アクティブなタブのすぐ右側に開きます
- **Left of current tab（現在のタブの左）**: 新規タブは現在アクティブなタブのすぐ左側に開きます
- **Default（デフォルト）**: Chromeのデフォルト動作を使用します

#### 追加機能：
- **New Tab Background（新規タブをバックグラウンドで）**: 新規タブをバックグラウンドで開くチェックボックスオプション（タブは開きますがアクティブになりません）
- **Matching URLs（URL一致ルール）**: 高度なURLベースの配置ルール
  - 各URLパターンに独自の位置設定（first/last/right/left/default）を設定可能
  - 各URLパターンにフォアグラウンド/バックグラウンドの開き方を指定可能
  - 複数のURLパターンを設定可能
  - URLパターンは新規タブが開かれたページと照合されます

### 2. Loading Page（ページ読み込み）

特定のURLへのナビゲーション時にタブの位置を制御します。この機能は直接ナビゲーションとサーバーリダイレクトの両方で動作します。

#### 機能：
- **Matching URLs（URL一致ルール）**: 位置ルール付きURLパターン（loadingurl）
  - 各URLはタブを以下の位置に配置するよう設定可能：
    - **Always last（常に最後）**: タブバーの末尾（sel: "last"）
    - **Always middle（常に中間）**: 既存タブの中間（sel: "middle"）
    - **Always first（常に最初）**: タブバーの先頭（sel: "first"）
  - 複数のURLパターンを設定可能
  - パターンはナビゲーション対象URLと照合されます
  - サーバーリダイレクトの場合は元のURLとも照合されます

### 3. Activate Tab After Tab Closing（タブを閉じた後のアクティブタブ）

現在のタブを閉じた際にどのタブをアクティブにするかを決定します。

#### オプション：
- **First tab（最初のタブ）**: ウィンドウ内の最初のタブをアクティブにします
- **Last tab（最後のタブ）**: ウィンドウ内の最後のタブをアクティブにします
- **Right tab（右のタブ）**: 閉じたタブの右側のタブをアクティブにします
- **Left tab（左のタブ）**: 閉じたタブの左側のタブをアクティブにします
- **In activated order（アクティブ化順）**: アクティブ化履歴に基づいて最近使用したタブをアクティブにします
- **Source tab (Open link)（元タブ - リンクを開く）**: 閉じたタブを開いた元のタブ（親タブ）に戻ります
- **Source tab (Open link) & In activated order（元タブとアクティブ化順の組み合わせ）**: 元タブとアクティブ化順のロジックを組み合わせます
- **Default（デフォルト）**: Chromeのデフォルト動作を使用します

### 4. Tab on Activate（タブアクティブ時）

タブがアクティブ化（フォーカスを取得）された際の配置動作を制御します。

#### オプション：
- **Default（デフォルト）**: 特別な配置動作なし（onactbutton1）
- **Last（最後）**: アクティブ化されたタブをタブバーの末尾に移動します（onactbutton2）
- **First（最初）**: アクティブ化されたタブをタブバーの先頭に移動します（onactbutton3）

### 5. External Links（外部リンク）

外部リンク（異なるドメインへのリンク）の処理方法を制御します。

#### 機能：
- **External Links in New Tab（外部リンクを新規タブで）**: メインチェックボックス（exlnk）
  - 有効にすると、外部ドメインへのリンクは現在のタブではなく新規タブで開きます
- **Matching URLs（URL一致ルール）**: 例外と上書きルール（expexlnkurl）
  - 特定の動作を持つURLパターン：
    - **Except (Page URL)（例外 - ページURL）**: このURLに一致するページを外部リンク処理から除外（sel: "except"）
    - **Force New Tab (Page URL)（強制新規タブ - ページURL）**: このURLに一致するページからのすべてのリンクを強制的に新規タブで開く（sel: "forcenew"）
    - **Force Background Tab (Page URL)（強制バックグラウンドタブ - ページURL）**: このURLに一致するページからのすべてのリンクを強制的にバックグラウンドタブで開く（sel: "forcebg"）
    - **Force Current Tab (Page URL)（強制現在のタブ - ページURL）**: このURLに一致するページからのすべてのリンクを強制的に現在のタブで開く（sel: "forcecrnt"）
    - **Force New Tab (A tag href)（強制新規タブ - リンクURL）**: このURLに一致するhrefを持つリンクを強制的に新規タブで開く（sel: "forcenewa"）
    - **Force Background Tab (A tag href)（強制バックグラウンドタブ - リンクURL）**: このURLに一致するhrefを持つリンクを強制的にバックグラウンドタブで開く（sel: "forcebga"）
    - **Force Current Tab (A tag href)（強制現在のタブ - リンクURL）**: このURLに一致するhrefを持つリンクを強制的に現在のタブで開く（sel: "forcecrnta"）

### 6. Pop-up（ポップアップ）

JavaScriptポップアップウィンドウの処理方法を制御します。

#### 機能：
- **Open pop-up window as new tab（ポップアップウィンドウを新規タブで開く）**: メインチェックボックス
  - 有効にすると、ポップアップウィンドウは別ウィンドウではなく通常のタブとして開きます
- **Exceptions（例外）**: ポップアップからタブへの変換をバイパスするURLパターン
  - 特定のサイトが実際のポップアップウィンドウを開くことを許可
  - 複数の例外URLを設定可能

## 追加機能

### キーボードショートカット

拡張機能はタブ管理用のキーボードショートカットを提供します：
- **Alt+T**: タイトルでタブをソート
- **Alt+U**: URLでタブをソート
- **Alt+C**: 現在のタブと最後にアクティブだったタブを切り替え

注意：ショートカットはChromeの拡張機能キーボードショートカット設定ページでカスタマイズ可能です。

### 設定のインポート/エクスポート

拡張機能はデータの可搬性を提供します：
- **Export Settings（設定をエクスポート）**: すべての設定を`tabposition.txt`ファイルに保存
- **Import Settings（設定をインポート）**: 以前にエクスポートしたファイルから設定を読み込み
- 設定はJSON形式で保存されます

## データストレージ

### ストレージ構造

拡張機能は以下のデータ構造でChromeのストレージAPIを使用します：

```javascript
{
  // 基本的なタブ配置
  osel: "openbutton1-5",        // 新規タブ位置の選択
  actb: "activebutton1-8",      // タブを閉じる動作
  onactvtb: "onactbutton1-3",   // タブアクティブ時の動作
  
  // 機能トグル
  newt: "true/false",            // 新規タブをバックグラウンドで
  popt: "true/false",            // ポップアップを新規タブで
  exlnk: true/null,              // 外部リンクを新規タブで
  
  // URLベースのルール
  openurl: [                     // 新規タブURLルール
    {
      url: "example.com",
      sel: "first/last/right/left/default",
      act: "fore/back"
    }
  ],
  
  expurl: [                      // ポップアップ例外URL
    {
      url: "example.com",
      sel: "1"
    }
  ],
  
  expexlnkurl: [                 // 外部リンク例外
    {
      url: "example.com",
      sel: "except/forcenew/forcebg/forcecrnt/forcenewa/forcebga/forcecrnta"
    }
  ],
  
  loadingurl: [                  // ページ読み込みURLルール
    {
      url: "example.com",
      sel: "last/middle/first"
    }
  ]
}
```

### ストレージ同期

拡張機能は高度なストレージ同期を実装しています：
- クロスデバイス同期のためにChrome Storage Sync APIを使用
- 同期クォータを超えた場合はLocal Storageにフォールバック
- Chromeの同期制限内で動作するよう大きなURLリストをチャンク化
- 古いストレージ形式との後方互換性を維持

## UIコンポーネント

### メイン設定ページ

オプションページは包括的なインターフェースを提供します：
- 青背景（#ebeff9）のセクションヘッダー
- 排他的オプション用のラジオボタングループ
- 機能トグル用のチェックボックス
- 追加/削除機能付きの動的URLリスト管理
- URL固有の動作用のドロップダウン選択
- フォーカス時の視覚的フィードバック（青いグロー効果）
- 長いURLリスト用のスクロール可能なコンテナ

### URLリスト管理

各URLリストセクションの機能：
- 新しいルールを追加する「Add」ボタン（青い楕円形ボタン）
- プレースホルダーテキスト付きURLパターン用テキスト入力
- 動作選択用のドロップダウン選択
- エントリ削除用のクローズボタン（X）
- リストアイテムのグレー背景
- リストが表示領域を超えた場合の自動スクロールコンテナ

## 外部リンク処理メカニズム

### コンテンツスクリプトの動作

コンテンツスクリプトは洗練されたリンク監視システムを実装：

**初期処理**：
- DOMContentLoadedイベントでバックグラウンドスクリプトに接続
- windowロードイベントで再接続
- ロード後400ms、800ms、1200msで追加の接続試行
- すべてのリンクをスキャンし、設定からURLパターンルールを適用
- マッチングルールに基づいてリンク動作を変更

**動的DOM監視**：
- MutationObserverを使用してページに追加された新しいリンクを検出（初期セットアップ後10ms遅延）
- childListとsubtreeの両方の変更を監視
- 動的にロードされたコンテンツ（AJAX、Reactなど）を処理
- ページ更新全体で一貫した動作を維持
- 個々のリンクのtarget属性変更も監視

**リンク動作変更戦略**：

1. **Target属性制御**: デフォルトのブラウザ動作を制御するために`target`属性を変更または削除
2. **イベントハンドラー注入**: preventDefaultして手動でタブを開く強制動作用のクリックハンドラーを追加
3. **優先順位ベースのルール適用**: 特定の優先順位で複数のマッチングルールを処理

**URLパターンマッチング階層**：
- 完全一致URLが優先
- 次にドメインレベルのルールを適用
- ページURLルール vs. リンクhrefルールは異なるスコープを持つ
- RegExpパターンは柔軟なマッチングを提供

### ストレージ管理戦略

拡張機能はChromeの同期制限を処理するための洗練されたストレージシステムを実装：

**クォータ管理**：
- Chrome Sync APIには厳格なクォータがある（合計102,400バイト、アイテムごとに8,192バイト）
- 拡張機能は書き込み前にストレージ使用量を監視
- 大規模データセットの自動チャンク化を実装

**データチャンク化アルゴリズム**：
- URLリストはアイテムごとの制限を超えるとチャンクに分割
- 各チャンクは数値サフィックスで保存
- 読み取り時に透過的に再構築

**フォールバック戦略**：
- 同期クォータを超えた場合、ローカルストレージにフォールバック
- ストレージモードを示すフラグを維持
- 可能な場合は同期ストレージへの移行を試みる

**後方互換性**：
- 古いストレージ形式からの移行をサポート
- チャンク化されたデータと非チャンク化データの両方を処理
- 拡張機能更新中にユーザー設定を保持

## イベント処理の考慮事項

### レースコンディション処理

拡張機能はいくつかのレースコンディションに対処：

**タブクローズのレースコンディション**：
- 問題：連続した複数のタブクローズイベントが不正なタブアクティベーションを引き起こす可能性
- 解決策：フラグとタイマーシステムを使用したデバウンスメカニズムを実装
- タイミング：関連するクローズイベントをバッチ処理するために180msのウィンドウを使用

**タブ作成と配置**：
- 問題：タブ位置計算が古いウィンドウ状態を使用する可能性
- 解決策：各操作後にウィンドウオブジェクトを更新
- 考慮事項：精度とパフォーマンスのバランス

### イベントシーケンシング

維持する必要がある重要なイベント順序：

1. **タブ作成フロー**：
   - `onCreated` → 位置計算 → 移動操作 → 状態更新
   - バックグラウンド/フォアグラウンドの決定は配置前に行う必要がある

2. **タブ削除フロー**：
   - `onRemoved` → アクティベーション履歴のクリーンアップ → 次のタブ選択 → フォーカス変更
   - 親子関係のクリーンアップが必要

3. **ナビゲーションフロー**：
   - `onBeforeNavigate` → 元のURLを保存 → `onCommitted` → リダイレクトをチェック
   - リダイレクト検出にはイベント間の相関が必要

### ポップアップウィンドウ処理

ポップアップウィンドウの特別な考慮事項：

**検出**：
- タイプ「popup」でウィンドウ作成を監視
- ユーザーポップアップと拡張機能ポップアップを区別する必要がある

**変換タイミング**：
- ポップアップからタブへの変換はウィンドウ作成後に発生
- 以前にフォーカスされた通常のウィンドウの追跡が必要
- 変換が拒否されるケースを処理する必要がある

**例外管理**：
- URLベースの例外は変換を防ぐ
- 変換を試みる前に例外リストをチェックする必要がある
- 成功した変換と失敗した変換の両方を適切に処理

## 技術的実装詳細

### Chrome APIイベント処理

拡張機能は複数のChrome APIを調整：

**必須イベント**：
- `chrome.tabs.*`: コアタブ操作と監視
- `chrome.windows.*`: ウィンドウ状態とフォーカス追跡
- `chrome.webNavigation.*`: 親子関係とリダイレクトのためのナビゲーション追跡
- `chrome.storage.*`: 設定の永続化と同期
- `chrome.runtime.*`: コンポーネント間のメッセージパッシング
- `chrome.commands.*`: キーボードショートカット処理

### 状態永続化戦略

**メモリ内状態**：
- タブアクティベーション履歴（パフォーマンス重視）
- ウィンドウ-タブ関係（頻繁にアクセス）
- レースコンディション処理用の一時フラグ

**永続的ストレージ**：
- ユーザー設定
- URLパターンルール
- 機能トグル

**セッションベースの状態**：
- 最近のタブ削除フラグ
- リダイレクト追跡情報
- 親子タブマッピング

### パフォーマンス最適化技術

**バッチ操作**：
- 可能な場合は複数のタブ操作をグループ化
- APIコールを削減するために重要でない更新を遅延
- ストレージ操作のための書き込み結合を実装

**キャッシング戦略**：
- クエリを削減するためにウィンドウとタブの状態をキャッシュ
- キャッシュデータのTTLを実装
- 関連イベントでキャッシュを無効化

**効率的なデータ構造**：
- O(1)ルックアップのためのオブジェクトマップを使用
- 順序付き操作のためのソート済み配列を維持
- メモリリークを防ぐためのクリーンアップルーチンを実装

## デフォルト動作

カスタム設定が設定されていない場合：
- 新規タブはChromeのデフォルト配置を使用
- タブを閉じる動作はChromeのデフォルトに従う
- 外部リンクは現在のタブで開く
- ポップアップは別ウィンドウとして開く
- URL固有のルールは適用されない

## 特別な動作とエッジケース

### ピン留めタブの処理

- ピン留めタブは常にChromeで通常のタブの前に表示される
- 「常に最初」が選択されている場合、新しいタブはピン留めタブの後に配置される
- タブのソート操作（Alt+T、Alt+U）はソート前にすべてのタブのピン留めを解除する

### ブラウザ起動とインストール時の動作

- 拡張機能は初回インストール時に自動的にオプションページを開く
- 拡張機能はウィンドウロードイベント後600msの遅延で初期化される
- タブとウィンドウの状態はパフォーマンス最適化のためにキャッシュされる
- 設定は起動時にChrome Storage Sync APIから読み込まれる
- 同期クォータを超えた場合はローカルストレージにフォールバックする
- 必要に応じて古いストレージ形式から新しいチャンク化形式への移行を試みる

### リダイレクト処理

- 拡張機能はリダイレクト発生前の元のURLを追跡する
- サーバーリダイレクトは`server_redirect`遷移修飾子で検出される
- URLマッチングルールはリダイレクト後のURLではなく元のURLに適用される
- リダイレクト追跡情報はタブが閉じられたときにクリーンアップされる

### タブ移動とタイミング

- タブアクティベーションイベントは処理前に1msの遅延がある
- タブクローズイベントはレースコンディション防止のため180msのデバウンスウィンドウを使用
- タブアクティブ時の移動はアクティベーション後260msの遅延がある
- ウィンドウオブジェクトは正確性を維持するためタブ操作後に更新される

## 制限事項と注意点

1. **Loading Page（ページ読み込み）**機能はナビゲーションイベントで実装され動作するが、UIでの露出が限定的
2. **Tab on Activate（タブアクティブ時）**機能はフォーカス時にタブを移動させるため、混乱を招く可能性がある
3. URLパターンマッチングは内部的に部分文字列マッチングと正規表現を使用
4. URLルールが多すぎると設定同期が失敗する可能性がある（Chrome Storage Sync APIクォータ：合計102,400バイト、アイテムごとに8,192バイト）
5. 拡張機能は機能するために「tabs」権限が必要
6. キーボードショートカットはグローバルで、他の拡張機能やアプリケーションと競合する可能性がある
7. タブアクティベーション履歴はブラウザ再起動時に永続化されない
8. タブIDと親子関係はブラウザ再起動時に失われる