# Tab Position Options - オリジナル拡張機能仕様書

## 概要

Tab Position Optionsは、タブの動作と配置を包括的に制御できるChrome拡張機能です。このドキュメントは、実装に基づいたオリジナル拡張機能の完全な動作仕様を記述しています。

## 設定カテゴリ

### 1. New Tab（新規タブ）

ブラウザの新規タブボタン（Ctrl+T、プラスボタンなど）を使用した際のタブ開き位置を制御します。

#### オプション：
- **Always first（常に最初）**: 新規タブは常にタブバーの先頭に開きます
- **Always last（常に最後）**: 新規タブは常にタブバーの末尾に開きます
- **Right of current tab（現在のタブの右）**: 新規タブは現在アクティブなタブのすぐ右側に開きます
- **Left of current tab（現在のタブの左）**: 新規タブは現在アクティブなタブのすぐ左側に開きます
- **Default（デフォルト）**: Chromeのデフォルト動作を使用します

#### 追加機能：
- **New Tab Background（新規タブをバックグラウンドで）**: 新規タブをバックグラウンドで開くチェックボックスオプション（タブは開きますがアクティブになりません）
- **Matching URLs（URL一致ルール）**: 高度なURLベースの配置ルール
  - 各URLパターンに独自の位置設定（first/last/right/left/default）を設定可能
  - 各URLパターンにフォアグラウンド/バックグラウンドの開き方を指定可能
  - 複数のURLパターンを設定可能
  - URLパターンは新規タブが開かれたページと照合されます

### 2. Loading Page（ページ読み込み）

リンクやプログラムによるナビゲーションから新しいページを読み込む際のタブ開き位置を制御します。この機能により、URL固有のタブ配置ルールが可能になります。

#### 機能：
- **Matching URLs（URL一致ルール）**: 位置ルール付きURLパターン
  - 各URLは以下の位置に開くよう設定可能：
    - **Always last（常に最後）**: タブバーの末尾
    - **Always middle（常に中間）**: 既存タブの中間
    - **Always first（常に最初）**: タブバーの先頭
  - 複数のURLパターンを設定可能
  - パターンは読み込まれる対象URLと照合されます

### 3. Activate Tab After Tab Closing（タブを閉じた後のアクティブタブ）

現在のタブを閉じた際にどのタブをアクティブにするかを決定します。

#### オプション：
- **First tab（最初のタブ）**: ウィンドウ内の最初のタブをアクティブにします
- **Last tab（最後のタブ）**: ウィンドウ内の最後のタブをアクティブにします
- **Right tab（右のタブ）**: 閉じたタブの右側のタブをアクティブにします
- **Left tab（左のタブ）**: 閉じたタブの左側のタブをアクティブにします
- **In activated order（アクティブ化順）**: アクティブ化履歴に基づいて最近使用したタブをアクティブにします
- **Source tab (Open link)（元タブ - リンクを開く）**: 閉じたタブを開いた元のタブ（親タブ）に戻ります
- **Source tab (Open link) & In activated order（元タブとアクティブ化順の組み合わせ）**: 元タブとアクティブ化順のロジックを組み合わせます
- **Default（デフォルト）**: Chromeのデフォルト動作を使用します

### 4. Tab on Activate（タブアクティブ時）

タブがアクティブ化（フォーカスを取得）された際の配置動作を制御します。

#### オプション：
- **Default（デフォルト）**: 特別な配置動作なし
- **Last（最後）**: アクティブ化されたタブをタブバーの末尾に移動します
- **First（最初）**: アクティブ化されたタブをタブバーの先頭に移動します

### 5. External Links（外部リンク）

外部リンク（異なるドメインへのリンク）の処理方法を制御します。

#### 機能：
- **External Links in New Tab（外部リンクを新規タブで）**: メインチェックボックス
  - 有効にすると、外部ドメインへのリンクは現在のタブではなく新規タブで開きます
- **Matching URLs（URL一致ルール）**: 例外と上書きルール
  - 特定の動作を持つURLパターン：
    - **Except (Page URL)（例外 - ページURL）**: ページURLを外部リンク処理から除外
    - **Force New Tab (Page URL)（強制新規タブ - ページURL）**: このページからのリンクを強制的に新規タブで開く
    - **Force Background Tab (Page URL)（強制バックグラウンドタブ - ページURL）**: このページからのリンクを強制的にバックグラウンドタブで開く
    - **Force Current Tab (Page URL)（強制現在のタブ - ページURL）**: このページからのリンクを強制的に現在のタブで開く
    - **Force New Tab (A tag href)（強制新規タブ - リンクURL）**: 特定のリンクURLを強制的に新規タブで開く
    - **Force Background Tab (A tag href)（強制バックグラウンドタブ - リンクURL）**: 特定のリンクURLを強制的にバックグラウンドタブで開く
    - **Force Current Tab (A tag href)（強制現在のタブ - リンクURL）**: 特定のリンクURLを強制的に現在のタブで開く

### 6. Pop-up（ポップアップ）

JavaScriptポップアップウィンドウの処理方法を制御します。

#### 機能：
- **Open pop-up window as new tab（ポップアップウィンドウを新規タブで開く）**: メインチェックボックス
  - 有効にすると、ポップアップウィンドウは別ウィンドウではなく通常のタブとして開きます
- **Exceptions（例外）**: ポップアップからタブへの変換をバイパスするURLパターン
  - 特定のサイトが実際のポップアップウィンドウを開くことを許可
  - 複数の例外URLを設定可能

## 追加機能

### キーボードショートカット

拡張機能はタブ管理用のキーボードショートカットを提供します：
- **Alt+T**: タイトルでタブをソート
- **Alt+U**: URLでタブをソート
- **Alt+C**: 現在のタブと最後にアクティブだったタブを切り替え

注意：ショートカットはChromeの拡張機能キーボードショートカット設定ページでカスタマイズ可能です。

### 設定のインポート/エクスポート

拡張機能はデータの可搬性を提供します：
- **Export Settings（設定をエクスポート）**: すべての設定を`tabposition.txt`ファイルに保存
- **Import Settings（設定をインポート）**: 以前にエクスポートしたファイルから設定を読み込み
- 設定はJSON形式で保存されます

## データストレージ

### ストレージ構造

拡張機能は以下のデータ構造でChromeのストレージAPIを使用します：

```javascript
{
  // 基本的なタブ配置
  osel: "openbutton1-5",        // 新規タブ位置の選択
  actb: "activebutton1-8",      // タブを閉じる動作
  onactvtb: "onactbutton1-3",   // タブアクティブ時の動作
  
  // 機能トグル
  newt: "true/false",            // 新規タブをバックグラウンドで
  popt: "true/false",            // ポップアップを新規タブで
  exlnk: true/null,              // 外部リンクを新規タブで
  
  // URLベースのルール
  openurl: [                     // 新規タブURLルール
    {
      url: "example.com",
      sel: "first/last/right/left/default",
      act: "fore/back"
    }
  ],
  
  expurl: [                      // ポップアップ例外URL
    {
      url: "example.com",
      sel: "1"
    }
  ],
  
  expexlnkurl: [                 // 外部リンク例外
    {
      url: "example.com",
      sel: "except/forcenew/forcebg/forcecrnt/forcenewa/forcebga/forcecrnta"
    }
  ],
  
  loadingurl: [                  // ページ読み込みURLルール
    {
      url: "example.com",
      sel: "last/middle/first"
    }
  ]
}
```

### ストレージ同期

拡張機能は高度なストレージ同期を実装しています：
- クロスデバイス同期のためにChrome Storage Sync APIを使用
- 同期クォータを超えた場合はLocal Storageにフォールバック
- Chromeの同期制限内で動作するよう大きなURLリストをチャンク化
- 古いストレージ形式との後方互換性を維持

## UIコンポーネント

### メイン設定ページ

オプションページは包括的なインターフェースを提供します：
- 青背景（#ebeff9）のセクションヘッダー
- 排他的オプション用のラジオボタングループ
- 機能トグル用のチェックボックス
- 追加/削除機能付きの動的URLリスト管理
- URL固有の動作用のドロップダウン選択
- フォーカス時の視覚的フィードバック（青いグロー効果）
- 長いURLリスト用のスクロール可能なコンテナ

### URLリスト管理

各URLリストセクションの機能：
- 新しいルールを追加する「Add」ボタン（青い楕円形ボタン）
- プレースホルダーテキスト付きURLパターン用テキスト入力
- 動作選択用のドロップダウン選択
- エントリ削除用のクローズボタン（X）
- リストアイテムのグレー背景
- リストが表示領域を超えた場合の自動スクロールコンテナ

## 技術的実装詳細

### イベント処理

拡張機能は以下をリッスンします：
- タブ作成イベント
- タブ削除イベント
- タブアクティブ化イベント
- ナビゲーションイベント
- ウィンドウポップアップリクエスト

### URLパターンマッチング

拡張機能のURLパターン：
- 部分的なドメインマッチングをサポート
- 大文字小文字を区別しない
- プロトコルを含む完全なURLと照合
- 定義された順序でルールを処理

### パフォーマンスの考慮事項

オリジナル拡張機能：
- タブアクティブ化履歴をメモリに保持
- URLルールを同期的に処理
- 変更時に設定を即座に更新
- 起動時にストレージから設定を再読み込み

## デフォルト動作

カスタム設定が設定されていない場合：
- 新規タブはChromeのデフォルト配置を使用
- タブを閉じる動作はChromeのデフォルトに従う
- 外部リンクは現在のタブで開く
- ポップアップは別ウィンドウとして開く
- URL固有のルールは適用されない

## 制限事項と注意点

1. **Loading Page（ページ読み込み）**機能はUIに部分的に実装されているが、完全に機能しない可能性がある
2. **Tab on Activate（タブアクティブ時）**機能はフォーカス時にタブを移動させるため、混乱を招く可能性がある
3. URLパターンマッチングは基本的な文字列マッチングで、正規表現やglobパターンではない
4. Chrome同期クォータ制限により、URLルールが多すぎると設定同期が失敗する可能性がある
5. 拡張機能は機能するために「tabs」権限が必要
6. キーボードショートカットはグローバルで、他の拡張機能やアプリケーションと競合する可能性がある